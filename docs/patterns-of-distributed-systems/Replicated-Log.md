# 复制日志

通过使用复制到所有集群节点的预写日志来保持多个节点的状态同步

## 问题

当多个节点需要共享状态时，这个状态就需要同步。所有集群节点的状态需要达成一致，即使某些节点断开或崩溃。这就需要给每个状态的更改请求要达成共识。

但是仅在单个请求中达成共识还不够。每个副本需要在相同的顺序中执行请求，否则不同的副本最后可能会得到不同的状态，即使它们对单个请求达成了共识。

## 解决方案

集群节点维护一个[预写日志](Write-Ahead-Log.md)。每个日志条目存储着共识所需要的状态以及用户请求。在这些日志条目之上一起达成一致（build consensus），所以集群所有的节点都必须明确相同的预写日志。然后请求按照日志顺序执行。因为所有集群节点都同意每个日志条目，所以它们以相同的顺序执行相同的请求。这确保了所有集群节点共享相同的状态。

使用 [Quorum](Quorum.md) 的容错共识构建机制需要两个阶段。

- 一是建立一个[生成时钟](Generation-Clock.md)以及了解在之前的 [Quorum](Quorum.md) 中复制的日志条目的阶段。
- 二是在集群所有节点上复制请求的阶段

为每个状态更改请求执行这两个阶段效率不高。所以集群节点在启动时选择一个 leader。在 leader 选举阶段建立[生成时钟](Generation-Clock.md)编号并检索前一个 [Quorum](Quorum.md) 的所有日志条目。（前一个领导者可能已经复制了大多数集群节点的条目。）一旦有一个稳定的 leader，只有 leader 协调复制。客户端与 leader 沟通。leader 将每个请求添加到日志中，并确保将其复制到所有 follower 上。一旦日志条目成功复制到大多数 follower，就会达成共识。这样，当有一个稳定的 leader 时，每个状态更改操作只需要一个阶段执行来达成共识。