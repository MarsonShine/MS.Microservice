<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      autoReload="true"
      throwConfigExceptions="true"
      internalLogLevel="Warn"
      internalLogFile="${basedir}/logs/internal-nlog.log">

  <!-- 全局变量：便于集中管理路径等配置 -->
  <variable name="logDir" value="${basedir}/logs/${year}/${month}" />
  <variable name="fileName" value="${logDir}/app-${shortdate}-${hours}.log" />

  <!-- 目标配置 -->
  <targets async="true">
    <!-- 控制台输出（开发期观察） -->
    <target xsi:type="Console" name="console" detectConsoleAvailable="true" />

    <!-- 文件输出（高效 + 低内存）
         NLog 5+ 已移除 concurrentWrites 属性。单进程高性能建议：keepFileOpen="true"
         多进程并发写入建议：keepFileOpen="false"（会降低性能但更安全）
    -->
    <target xsi:type="File" name="file"
            fileName="${fileName}"
            keepFileOpen="true"
            encoding="utf-8"
            archiveEvery="Day"
            archiveNumbering="Rolling"
            maxArchiveFiles="14"
            archiveAboveSize="104857600">
      <layout>
        <!-- 结构化文本布局，包含关键的请求上下文与自定义渲染器 -->
        ${longdate} | ${uppercase:${level}} | ${logger} | ${aspnet-request-method} ${aspnet-request-url} | rid=${requestId} pid=${platformId} uflag=${userflag} | dur=${RequestDuration} | msg=${message} ${onexception:inner=${exception:format=ToString}}
      </layout>
    </target>

    <!-- 如需网络转发目标，请添加 NuGet 包 NLog.Targets.Network 后取消下面的注释 -->
    <!--
    <target xsi:type="Network" name="net"
            address="${NetAddress}"
            keepAlive="true"
            newLine="true">
      <layout>
        ${longdate}|${uppercase:${level}}|${logger}|${aspnet-request-method} ${aspnet-request-url}|rid=${requestId}|pid=${platformId}|uflag=${userflag}|dur=${RequestDuration}|${message}${onexception:inner=|${exception:format=ToString}}
      </layout>
    </target>
    -->
  </targets>

  <!-- 规则配置 -->
  <rules>
    <logger name="*" minlevel="Info" writeTo="console" />
    <logger name="*" minlevel="Info" writeTo="file" />
    <!-- 启用网络转发时，同时打开下面这条规则 -->
    <!-- <logger name="*" minlevel="Warn" writeTo="net" /> -->
  </rules>
</nlog>
